<!DOCTYPE html>
<html lang="zh-cn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¯»å® - å¼‚æ­¥åŠ¨ç”»æ¼”ç¤º</title>
    <style>
        /*å…¨å±€æ ·å¼é‡ç½®*/
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        /*ä¸»ä½“æ ·å¼--èƒŒæ™¯è®¾ç½®*/
        body {
            font-family: 'Microsoft YaHei', 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #f4e4bc 0%, #d4a574 50%, #b8860b 100%);
            min-height: 100vh;
            color: #5d4e37;
        }

        .game-container {
            max-width: 900px;
            margin: 0 auto;
            padding: 20px;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .header {
            text-align: center;
            margin-bottom: 25px;
            color: #8b4513;
        }

        .header h1 {
            font-size: 2.2em;
            margin-bottom: 8px;
            text-shadow: 1px 1px 2px rgba(139, 69, 19, 0.3);
            font-weight: 600;
        }

        .header p {
            font-size: 1em;
            opacity: 0.8;
        }

        .game-area {
            background: rgba(255, 248, 220, 0.9);
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 8px 25px rgba(139, 69, 19, 0.15);
            flex: 1;
            display: flex;
            flex-direction: column;
            border: 2px solid #daa520;
        }

        .story-section {
            flex: 1;
            margin-bottom: 20px;
        }

        .story-text {
            font-size: 1.1em;
            line-height: 1.7;
            margin-bottom: 20px;
            padding: 20px;
            background: #fff8dc;
            border-radius: 8px;
            border-left: 4px solid #daa520;
            min-height: 100px;
            box-shadow: inset 0 1px 3px rgba(139, 69, 19, 0.1);
        }

        .progress-section {
            margin-bottom: 15px;
        }

        .progress-bar {
            width: 100%;
            height: 6px;
            background: #f5deb3;
            border-radius: 3px;
            overflow: hidden;
            border: 1px solid #daa520;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #daa520, #b8860b);
            width: 0%;
            transition: width 0.5s ease;
        }

        .status-section {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            background: #fff8dc;
            border-radius: 8px;
            margin-bottom: 15px;
            border: 1px solid #daa520;
        }

        .status-item {
            text-align: center;
        }

        .status-label {
            font-size: 0.85em;
            color: #8b4513;
            margin-bottom: 3px;
        }

        .status-value {
            font-size: 1.1em;
            font-weight: bold;
            color: #5d4e37;
        }

        .controls {
            display: flex;
            gap: 12px;
            justify-content: center;
        }

        .control-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            font-size: 0.95em;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
        }

        .start-btn {
            background: #228b22;
            color: white;
        }

        .restart-btn {
            background: #cd853f;
            color: white;
        }

        .control-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 3px 8px rgba(0,0,0,0.2);
        }

        .loading {
            display: none;
            text-align: center;
            padding: 15px;
            color: #8b4513;
        }

        .loading.show {
            display: block;
        }

        .spinner {
            border: 2px solid #f5deb3;
            border-top: 2px solid #daa520;
            border-radius: 50%;
            width: 25px;
            height: 25px;
            animation: spin 1s linear infinite;
            margin: 0 auto 8px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .image-placeholder {
            width: 100%;
            height: 220px;
            background: #f5deb3;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 12px 0;
            color: #8b4513;
            font-style: italic;
            border: 2px dashed #daa520;
            font-size: 0.9em;
            position: relative;
            overflow: hidden;
        }

        /*å›¾ç‰‡è‡ªé€‚åº”æ ·å¼ */
        .image-placeholder img {
            max-width: 100%;
            max-height: 100%;
            width: auto;
            height: auto;
            object-fit: cover;
            display: block;
            border-radius: 6px;
        }

        .image-caption {
            position: absolute;
            left: 12px;
            bottom: 8px;
            background: rgba(255,255,255,0.85);
            padding: 6px 10px;
            border-radius: 6px;
            font-size: 0.9em;
            color: #8b4513;
            box-shadow: 0 2px 6px rgba(0,0,0,0.08);
        }

        @media (max-width: 768px) {
            .game-container {
                padding: 10px;
            }
            
            .header h1 {
                font-size: 1.8em;
            }
            
            .status-section {
                flex-direction: column;
                gap: 8px;
            }

            .image-placeholder { height: 160px; }
        }
    </style>
</head>
<body>
    <!-- æ¸¸æˆä¸»å®¹å™¨ -->
    <div class="game-container">
        <!-- é¡µé¢å¤´éƒ¨ -->
        <div class="header">
            <h1>ğŸœï¸ å¯»å®æ¢é™©</h1>
            <p>è·Ÿéšçº¿ç´¢ç©¿è¶Šæ²™æ¼ ï¼Œä½“éªŒå†’é™©ä¹‹æ—…ï¼</p>
        </div>

        <!-- æ¸¸æˆä¸»åŒºåŸŸ -->
        <div class="game-area">
            <!-- è¿›åº¦æ¡åŒºåŸŸ -->
            <div class="progress-section">
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill"></div>
                </div>
            </div>

            <!-- æ­¥éª¤æŒ‡ç¤ºå™¨ - 6ä¸ªåœ†ç‚¹æ˜¾ç¤ºå½“å‰è¿›åº¦ -->
            <div class="step-indicator">
                <div class="step-dot" id="step1"></div>
                <div class="step-dot" id="step2"></div>
                <div class="step-dot" id="step3"></div>
                <div class="step-dot" id="step4"></div>
                <div class="step-dot" id="step5"></div>
                <div class="step-dot" id="step6"></div>
            </div>

            <!-- çŠ¶æ€ä¿¡æ¯æ  -->
            <div class="status-section">
                <div class="status-item">
                    <div class="status-label">å½“å‰é˜¶æ®µ</div>
                    <div class="status-value" id="currentStage">å‡†å¤‡ä¸­</div>
                </div>
                <div class="status-item">
                    <div class="status-label">æ¢é™©è¿›åº¦</div>
                    <div class="status-value" id="progress">0%</div>
                </div>
                <div class="status-item">
                    <div class="status-label">çŠ¶æ€</div>
                    <div class="status-value" id="status">å¾…å¼€å§‹</div>
                </div>
            </div>

            <!-- æ•…äº‹å†…å®¹åŒºåŸŸ -->
            <div class="story-section">
                <!-- æ•…äº‹æ–‡æœ¬æ˜¾ç¤ºåŒºåŸŸ -->
                <div class="story-text" id="storyText">
                    æ¬¢è¿æ¥åˆ°å¯»å®æ¢é™©ï¼<br><br>
                    ä½ å°†æ‰®æ¼”ä¸€ä½å‹‡æ•¢çš„æ¢é™©å®¶ï¼Œæ ¹æ®å¤è€çš„çº¿ç´¢ç©¿è¶Šæ²™æ¼ å¯»æ‰¾ä¼ è¯´ä¸­çš„å®è—ã€‚
                    æ¯ä¸€æ­¥éƒ½éœ€è¦è€å¿ƒç­‰å¾…ï¼Œå› ä¸ºè¿™æ˜¯å¼‚æ­¥ç¼–ç¨‹ã€‚<br><br>
                    å¥½äº†ç°åœ¨è¯·ç‚¹å‡»"å¼€å§‹æ¢é™©"å¼€å§‹ä½ çš„å¯»å®ä¹‹æ—…ï¼
                </div>

                <!-- å›¾ç‰‡å±•ç¤ºåŒºåŸŸ -->
                <div class="image-placeholder" id="imagePlaceholder">
                    <img id="stepImage" src="./image/placeholder.jpg" alt="é»˜è®¤å›¾ç‰‡" />
                    <div id="imageCaption" class="image-caption">è¯´æ˜</div>
                </div>

                <!-- åŠ è½½åŠ¨ç”» -->
                <div class="loading" id="loading">
                    <div class="spinner"></div>
                    <div>æ­£åœ¨å¤„ç†ä½ çš„é€‰æ‹©...</div>
                </div>
            </div>

            <!-- æ§åˆ¶æŒ‰é’®åŒºåŸŸ -->
            <div class="controls">
                <button class="control-btn start-btn" id="startBtn">å¼€å§‹æ¢é™©</button>
                <button class="control-btn restart-btn" id="restartBtn" style="display: none;">é‡æ–°å¼€å§‹</button>
            </div>
        </div>
    </div>

    <!-- JavaScript ä»£ç åŒºåŸŸ -->
    <script>
        // TreasureMap ç±»å®šä¹‰
        // æ¨¡æ‹Ÿå®è—åœ°å›¾APIï¼Œæä¾›å¼‚æ­¥å¯»å®åŠŸèƒ½ï¼ˆæ¥è‡ª rewrite2.0.jsï¼‰
        class TreasureMap {
            // è·å–åˆå§‹çº¿ç´¢ - 1ç§’åè¿”å›ç»“æœ
            static getInitialClue() {
              return new Promise((resolve) => {
                setTimeout(() => {
                  resolve("åœ¨å¤è€çš„å›¾ä¹¦é¦†é‡Œæ‰¾åˆ°äº†ç¬¬ä¸€ä¸ªçº¿ç´¢...");
                }, 1000);
              });
            }
          
            // è§£ç å¤æ–‡å­— - 1.5ç§’åè¿”å›ç»“æœï¼Œå¦‚æœæ²¡æœ‰çº¿ç´¢åˆ™å¤±è´¥
            static decodeAncientScript(clue) {
              return new Promise((resolve, reject) => {
                setTimeout(() => {
                  if (!clue) {
                    reject("æ²¡æœ‰çº¿ç´¢å¯ä»¥è§£ç !");
                  }
                  resolve("è§£ç æˆåŠŸ!å®è—åœ¨ä¸€åº§å¤è€çš„ç¥åº™ä¸­...");
                }, 1500);
              });
            }

            // è·å–ä¸‹ä¸€æ­¥æ–¹å‘ - 1.2ç§’åè¿”å›ï¼Œ50%æ¦‚ç‡æœ‰æ–¹å‘
            static nextStep() {
              return new Promise((resolve) => {
                setTimeout(() => {
                  const random = Math.random();
                    if (random < 0.5) {
                      // æœ‰æç¤ºï¼šè¿”å›æ–¹å‘ï¼ˆé nullï¼‰å’Œè¦æ‰“å°çš„ä¿¡æ¯
                      resolve({ direction: 'å‘ä¸œå—æ–¹å‰è¿›3å…¬é‡Œ', message: 'çº¿ç´¢ä¸­éšè—äº†ä¸€ä¸ªæ–¹å‘...' });
                    } else {
                      // æ— æç¤ºï¼šdirection ä¸º nullï¼Œä½†ä»è¿”å›è¦æ‰“å°çš„ä¿¡æ¯
                      resolve({ direction: null, message: 'åŸ‹å¤´ç»§ç»­å‘å‰èµ°...' });
                    }
                }, 1200);
              });
            }

            // ç©¿è¶Šæ²™æ¼  - 2ç§’åè¿”å›ç»“æœï¼Œå¦‚æœæ²¡æœ‰æ–¹å‘åˆ™å¤±è´¥
            static traverseDesert(direction) {
              return new Promise((resolve, reject) => {
                setTimeout(() => {
                  if (!direction) {
                    reject("æ²¡æœ‰æ–¹å‘ï¼Œè¿·å¤±åœ¨æ²™æ¼ !");
                  }
                  resolve(`æ‰¾åˆ°äº†æ–¹å‘:${direction}ï¼ŒæˆåŠŸç©¿è¶Šæ²™æ¼ ï¼Œçœ‹åˆ°äº†ç¥åº™çš„è½®å»“!`);
                }, 2000);
              });
            }

            // ç¥åº™æ¢ç´¢ - 2ç§’åè¿”å›ç»“æœï¼Œ50%æ¦‚ç‡é‡åˆ°å®ˆå«å¤±è´¥
            static searchTemple(location) {
              return new Promise((resolve, reject) => {
                setTimeout(() => {
                  const random = Math.random();
                  if (random < 0.5) {
                    reject("ç³Ÿç³•!é‡åˆ°äº†ç¥åº™å®ˆå«!");
                  }
                  resolve("æ‰¾åˆ°äº†ä¸€ä¸ªç¥ç§˜çš„ç®±å­...");
                }, 2000);
              });
            }

            // æ‰“å¼€å®ç®± - 1ç§’åè¿”å›æˆåŠŸç»“æœ
            static openTreasureBox() {
              return new Promise((resolve) => {
                setTimeout(() => {
                  resolve("æ­å–œ!ä½ æ‰¾åˆ°äº†ä¼ è¯´ä¸­çš„å®è—!");
                }, 1000);
              });
            }
        }

        // é¡µé¢æ§åˆ¶å™¨ï¼ˆç®€æ´ç‰ˆï¼‰ï¼Œä½¿ç”¨ç°æœ‰ DOM å…ƒç´ 
        (function () {
            const startBtn = document.getElementById('startBtn');
            const restartBtn = document.getElementById('restartBtn');
            const storyText = document.getElementById('storyText');
            const imagePlaceholder = document.getElementById('imagePlaceholder');
            const stepImage = document.getElementById('stepImage');
            const imageCaption = document.getElementById('imageCaption');
            const loading = document.getElementById('loading');
            const progressFill = document.getElementById('progressFill');
            const progressLabel = document.getElementById('progress');
            const statusLabel = document.getElementById('status');
            const currentStage = document.getElementById('currentStage');

            const totalSteps = 6;
            // æŠŠå›¾ç‰‡è·¯å¾„å’Œè¯´æ˜åŠ å…¥åˆ°å…ƒä¿¡æ¯
            const stepsMeta = [
                { title: "è·å–åˆå§‹çº¿ç´¢", image: "./image/step1.jpg", alt: "å¤è€å›¾ä¹¦é¦†" },
                { title: "è§£ç å¤æ–‡å­—", image: "./image/step2.jpg", alt: "è§£è¯»å¤æ–‡å­—" },
                { title: "å‘ç°æ–¹å‘", image: "./image/step3.jpg", alt: "å‘ç°æ–¹å‘" },
                { title: "ç©¿è¶Šæ²™æ¼ ", image: "./image/step4.jpg", alt: "ç©¿è¶Šæ²™æ¼ " },
                { title: "ç¥åº™æ¢ç´¢", image: "./image/step5.jpg", alt: "ç¥åº™å…¥å£" },
                { title: "è·å¾—å®è—", image: "./image/step6.jpg", alt: "é—ªäº®å®è—" }
            ];

            let lastClue = null;
            let lastDirection = null;
            let isRunning = false;

            /*å·¥å…·å‡½æ•° */
            
            // æ˜¾ç¤º/éšè—åŠ è½½åŠ¨ç”»
            function setLoading(show) {
                if (show) loading.classList.add('show');
                else loading.classList.remove('show');
            }

            // æ›´æ–°è¿›åº¦æ¡å’Œæ­¥éª¤æŒ‡ç¤ºå™¨
            function updateProgress(stepIndex) {
                const progress = Math.round(((stepIndex + 1) / totalSteps) * 100);
                progressFill.style.width = progress + '%';
                progressLabel.textContent = progress + '%';
                
                // æ›´æ–°æ­¥éª¤æŒ‡ç¤ºå™¨åœ†ç‚¹çŠ¶æ€
                for (let i = 1; i <= totalSteps; i++) {
                    const dot = document.getElementById(`step${i}`);
                    if (!dot) continue;
                    dot.classList.remove('active','completed');
                    if (i - 1 < stepIndex) dot.classList.add('completed');  // å·²å®Œæˆçš„æ­¥éª¤
                    else if (i - 1 === stepIndex) dot.classList.add('active');  // å½“å‰æ­¥éª¤
                }
            }

            // æ·»åŠ ç»“æœæ¶ˆæ¯åˆ°æ•…äº‹æ–‡æœ¬åŒºåŸŸ
            function appendResultMessage(msg, isError = false) {
                // æ¥å—å·²ç»æ ¼å¼åŒ–çš„å­—ç¬¦ä¸²
                const div = document.createElement('div');
                div.className = isError ? 'error-message' : 'success-message';
                div.style.marginTop = '10px';
                div.textContent = msg;
                storyText.appendChild(div);
                storyText.scrollTop = storyText.scrollHeight;
            }

            // æŠŠå¼‚æ­¥è¿”å›å€¼æ ¼å¼åŒ–ä¸ºå¯è¯»å­—ç¬¦ä¸²
            function formatResult(res) {
                if (res === null || res === undefined) return String(res);
                if (typeof res === 'object') {
                    // å¸¸è§çš„ { direction, message } æ ¼å¼ä¼˜å…ˆå±•ç¤º message å’Œ direction
                    if ('message' in res || 'direction' in res) {
                        const msg = res.message ? String(res.message) : '';
                        const dir = res.direction ? String(res.direction) : '';
                        return dir ? (msg + 'ï¼ˆæ–¹å‘ï¼š' + dir + 'ï¼‰') : msg || JSON.stringify(res);
                    }
                    // å…¶ä»–å¯¹è±¡ä½¿ç”¨ JSON å­—ç¬¦ä¸²
                    try {
                        return JSON.stringify(res);
                    } catch (e) {
                        return String(res);
                    }
                }
                return String(res);
            }

            // é¢„åŠ è½½å›¾ç‰‡
            function preloadImages(list) {
                list.forEach(src => {
                    const img = new Image();
                    img.src = src;
                });
            }

            async function executeStep(index, fn) {
                currentStage.textContent = stepsMeta[index].title;
                statusLabel.textContent = 'è¿›è¡Œä¸­';
                // æ˜¾ç¤ºå¯¹åº”å›¾ç‰‡ä¸è¯´æ˜
                if (stepImage && stepsMeta[index].image) {
                    stepImage.src = stepsMeta[index].image;
                    stepImage.alt = stepsMeta[index].alt || stepsMeta[index].title;
                }
                if (imageCaption) imageCaption.textContent = stepsMeta[index].alt || stepsMeta[index].title;
                setLoading(true);
                updateProgress(index);

                try {
                    const res = await fn();
                    appendResultMessage(formatResult(res));
                    await new Promise(r => setTimeout(r, 900));
                    return res;
                } finally {
                    setLoading(false);
                }
            }

            /* ä¸»è¦æ¸¸æˆé€»è¾‘ */
            
            // è¿è¡Œå¯»å®æ¸¸æˆä¸»æµç¨‹
            async function runTreasureHunt() {
                isRunning = true;
                startBtn.style.display = 'none';
                restartBtn.style.display = 'inline-block';
                storyText.innerHTML = ''; // æ¸…ç©ºå†å²æ¶ˆæ¯
                statusLabel.textContent = 'è¿›è¡Œä¸­';

                try {
                    // step 0
                    lastClue = await executeStep(0, () => TreasureMap.getInitialClue());

                    // step 1
                    const decoded = await executeStep(1, () => TreasureMap.decodeAncientScript(lastClue));

                    // step 2
                    const next = await executeStep(2, () => TreasureMap.nextStep());
                    lastDirection = next && next.direction ? next.direction : null;

                    // step 3
                    const traversed = await executeStep(3, () => TreasureMap.traverseDesert(lastDirection));

                    // step 4
                    const box = await executeStep(4, () => TreasureMap.searchTemple(traversed));

                    // step 5
                    const treasure = await executeStep(5, () => TreasureMap.openTreasureBox());

                    // æˆåŠŸå±•ç¤º
                    statusLabel.textContent = 'æ¢é™©å®Œæˆ';
                    currentStage.textContent = 'å®Œæˆ';
                    if (stepImage) {
                        stepImage.src = './image/success.jpg';
                        stepImage.alt = 'æ¢é™©æˆåŠŸ';
                    }
                    if (imageCaption) imageCaption.textContent = 'æ¢é™©æˆåŠŸ';
                    appendResultMessage('ğŸ‰ æ¢é™©æˆåŠŸï¼Œè·å¾—å®è—ï¼');
                } catch (err) {
                    // ç»Ÿä¸€é”™è¯¯å¤„ç†
                    statusLabel.textContent = 'æ¢é™©å¤±è´¥';
                    const msg = err && err.toString ? err.toString() : String(err);
                    appendResultMessage('é”™è¯¯ï¼š' + msg, true);
                    if (stepImage) {
                        stepImage.src = './image/fail.jpg';
                        stepImage.alt = 'æ¢é™©å¤±è´¥';
                    }
                    if (imageCaption) imageCaption.textContent = 'æ¢é™©å¤±è´¥';
                } finally {
                    isRunning = false;
                }
            }

            function resetUI() {
                lastClue = null;
                lastDirection = null;
                storyText.innerHTML = `æ¬¢è¿æ¥åˆ°å¯»å®æ¢é™©ï¼<br><br>ç‚¹å‡»â€œå¼€å§‹æ¢é™©â€ä½“éªŒå¼‚æ­¥å¯»å®æµç¨‹ã€‚`;
                progressFill.style.width = '0%';
                progressLabel.textContent = '0%';
                currentStage.textContent = 'å‡†å¤‡ä¸­';
                statusLabel.textContent = 'å¾…å¼€å§‹';
                for (let i = 1; i <= totalSteps; i++) {
                    const dot = document.getElementById(`step${i}`);
                    if (dot) dot.classList.remove('active','completed');
                }
                startBtn.style.display = 'inline-block';
                restartBtn.style.display = 'none';
                setLoading(false);
                // æ¢å¤é»˜è®¤å ä½å›¾ä¸è¯´æ˜
                if (stepImage) stepImage.src = './image/placeholder.jpg';
                if (imageCaption) imageCaption.textContent = 'ğŸœï¸ å‡†å¤‡å‡ºå‘';
                // é¢„åŠ è½½æ‰€æœ‰æ­¥éª¤å›¾ä¸ç»“æœå›¾ï¼ˆå¯æ³¨é‡Šæ‰é¿å… 404ï¼‰
                preloadImages(stepsMeta.map(s => s.image).concat(['./image/placeholder.jpg']));
            }

            /* äº‹ä»¶ç»‘å®š */
            
            // ç»‘å®šå¼€å§‹æŒ‰é’®ç‚¹å‡»äº‹ä»¶
            startBtn.addEventListener('click', () => {
                if (!isRunning) runTreasureHunt();
            });
            
            // ç»‘å®šé‡æ–°å¼€å§‹æŒ‰é’®ç‚¹å‡»äº‹ä»¶
            restartBtn.addEventListener('click', () => {
                if (isRunning) return;
                resetUI();
            });

            // é¡µé¢åˆå§‹
            resetUI();
        })();
    </script>
</body>
</html>